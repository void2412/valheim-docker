#!/bin/bash
# Valheim world backup script
# Creates compressed backups with rotation by age and count

set -e
SCRIPT_NAME="backup"
source /opt/valheim/scripts/common.sh

# Check if backups are enabled
check_backup_enabled() {
    if [[ "$BACKUPS" != "true" ]]; then
        echo "Backups disabled, skipping"
        return 1
    fi
    return 0
}

# Check idle requirement
# BACKUPS_IF_IDLE=true  → backup always (even when no players)
# BACKUPS_IF_IDLE=false → only backup when players are connected
check_idle_requirement() {
    if [[ "$BACKUPS_IF_IDLE" == "true" ]]; then
        return 0  # Backup regardless of idle status
    fi

    # Only backup when players are connected
    if is_server_idle; then
        echo "Server idle, skipping backup"
        return 1
    fi

    return 0  # Players connected, proceed with backup
}

# Create world backup
create_backup() {
    local world_dir="$CONFIG_DIR/worlds_local"

    # Check if world directory exists
    if [[ ! -d "$world_dir" ]]; then
        echo "World directory not found: $world_dir"
        return 1
    fi

    # Check if world files exist
    if [[ ! -f "$world_dir/${WORLD_NAME}.db" ]]; then
        echo "World file not found: ${WORLD_NAME}.db"
        return 1
    fi

    # Create backup directory
    mkdir -p "$BACKUP_DIR"

    # Generate backup filename
    local timestamp
    timestamp=$(date +%Y%m%d-%H%M%S)
    local backup_name="${WORLD_NAME}-${timestamp}"

    # Create backup
    echo "Creating backup: $backup_name"
    if [[ "$BACKUPS_COMPRESS" == "true" ]]; then
        local backup_file="$BACKUP_DIR/${backup_name}.tar.gz"
        tar -czf "$backup_file" -C "$world_dir" .
    else
        local backup_file="$BACKUP_DIR/${backup_name}.tar"
        tar -cf "$backup_file" -C "$world_dir" .
    fi

    # Also backup adminlist, bannedlist, permittedlist if they exist
    for list_file in adminlist.txt bannedlist.txt permittedlist.txt; do
        if [[ -f "$CONFIG_DIR/$list_file" ]]; then
            cp "$CONFIG_DIR/$list_file" "$BACKUP_DIR/${WORLD_NAME}-${timestamp}-${list_file}"
        fi
    done

    echo "Backup complete"
    return 0
}

# Backup ServerCharacters data if it exists
backup_server_characters() {
    local chars_dir="$CONFIG_DIR/servercharacters"

    if [[ ! -d "$chars_dir" ]]; then
        return 0  # No ServerCharacters data
    fi

    local fch_count
    fch_count=$(find "$chars_dir" -name "*.fch" -type f 2>/dev/null | wc -l)

    if [[ $fch_count -eq 0 ]]; then
        return 0
    fi

    local timestamp
    timestamp=$(date +%Y%m%d-%H%M%S)
    local backup_file="$BACKUP_DIR/servercharacters-${timestamp}.tar.gz"

    tar -czf "$backup_file" -C "$chars_dir" .
}

# Remove old backups by age
cleanup_by_age() {
    local max_age="${BACKUPS_MAX_AGE:-0}"
    if [[ ! "$max_age" =~ ^[0-9]+$ ]] || [[ "$max_age" -le 0 ]]; then
        return 0
    fi

    local count
    count=$(find "$BACKUP_DIR" -name "${WORLD_NAME}-*" -type f -mtime +$max_age 2>/dev/null | wc -l)

    if [[ $count -gt 0 ]]; then
        echo "Removing $count backup(s) older than $max_age days"
        find "$BACKUP_DIR" -name "${WORLD_NAME}-*" -type f -mtime +$max_age -delete
    fi
}

# Remove old backups by count
cleanup_by_count() {
    local max_count="${BACKUPS_MAX_COUNT:-0}"
    if [[ ! "$max_count" =~ ^[0-9]+$ ]] || [[ "$max_count" -le 0 ]]; then
        return 0  # 0 or invalid means unlimited
    fi

    local current_count
    current_count=$(find "$BACKUP_DIR" -name "${WORLD_NAME}-*.tar*" -type f 2>/dev/null | wc -l)

    if [[ $current_count -le $max_count ]]; then
        return 0
    fi

    local to_delete=$((current_count - max_count))
    echo "Removing $to_delete old backup(s) (keeping $max_count)"

    # Delete oldest files first
    find "$BACKUP_DIR" -name "${WORLD_NAME}-*.tar*" -type f -printf '%T+ %p\n' 2>/dev/null \
        | sort \
        | head -n $to_delete \
        | cut -d' ' -f2- \
        | xargs -r rm -f
}

# Print backup config
print_config() {
    echo "World: $WORLD_NAME | Compress: $BACKUPS_COMPRESS | MaxAge: ${BACKUPS_MAX_AGE}d | MaxCount: $BACKUPS_MAX_COUNT | IdleBackup: $BACKUPS_IF_IDLE"
}

# Main
main() {
    echo "=== Backup Starting ==="
    print_config

    # Check if backups enabled
    if ! check_backup_enabled; then
        echo "=== Backup Skipped ==="
        exit 0
    fi

    # Check idle requirement
    if ! check_idle_requirement; then
        echo "=== Backup Skipped ==="
        exit 0
    fi

    # Create backup
    if ! create_backup; then
        echo "=== Backup Failed ==="
        exit 1
    fi

    # Backup ServerCharacters if present
    backup_server_characters

    # Cleanup old backups
    cleanup_by_age
    cleanup_by_count

    echo "=== Backup Complete ==="
}

main "$@"
