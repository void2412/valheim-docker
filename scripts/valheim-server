#!/bin/bash
# Valheim server launcher script
# Handles BepInEx integration and graceful shutdown with repeated SIGINT

source /opt/valheim/scripts/common.sh

SERVER_PID=""

# Signal handler - sends SIGINT every 15 seconds until server exits
shutdown_server() {
    if [[ -z "$SERVER_PID" ]] || ! kill -0 "$SERVER_PID" 2>/dev/null; then
        exit 0
    fi

    echo "Shutting down server (PID: $SERVER_PID)..."

    while kill -0 "$SERVER_PID" 2>/dev/null; do
        kill -INT "$SERVER_PID" 2>/dev/null || true
        echo "Sent SIGINT to server..."

        # Wait up to 15 seconds, checking every second
        for i in {1..10}; do
            sleep 1
            if ! kill -0 "$SERVER_PID" 2>/dev/null; then
                echo "Server stopped"
                wait "$SERVER_PID" 2>/dev/null
                exit 0
            fi
        done
    done

    exit 0
}

trap shutdown_server SIGINT SIGTERM

# Reset environment for clean start
unset LD_PRELOAD
unset LD_LIBRARY_PATH
unset DOORSTOP_ENABLED
unset DOORSTOP_TARGET_ASSEMBLY

# Clean up any lingering processes
if pgrep -f "valheim_server.x86_64" > /dev/null 2>&1; then
    pkill -9 -f "valheim_server.x86_64" 2>/dev/null || true
    sleep 2
fi

rm -f "$CONFIG_DIR"/*.lock 2>/dev/null || true
rm -rf /tmp/crashes /tmp/unity* /tmp/Crash* 2>/dev/null || true

# Check if server files exist
if [[ ! -f "$VALHEIM_DIR/valheim_server.x86_64" ]]; then
    exit 1
fi

# Setup BepInEx if enabled
if [[ "$BEPINEX" == "true" ]]; then
    if [[ -d "$VALHEIM_DIR/BepInEx" ]] && \
       [[ -d "$VALHEIM_DIR/doorstop_libs" ]] && \
       [[ -f "$VALHEIM_DIR/doorstop_libs/libdoorstop_x64.so" ]] && \
       [[ -f "$VALHEIM_DIR/BepInEx/core/BepInEx.Preloader.dll" ]]; then
        rm -rf "$VALHEIM_DIR/BepInEx/cache" 2>/dev/null || true
        mkdir -p "$VALHEIM_DIR/BepInEx/plugins" 2>/dev/null || true
    else
        BEPINEX="false"
    fi
fi

cd "$VALHEIM_DIR"

# Validate password
if [[ -n "$SERVER_PASS" && ${#SERVER_PASS} -lt 5 ]]; then
    exit 1
fi

export LD_LIBRARY_PATH="./linux64"
export SteamAppId=892970

# Initialize activity timestamp
update_activity_timestamp

# Start server
if [[ "$BEPINEX" == "true" ]]; then
    export DOORSTOP_ENABLED=1
    export DOORSTOP_TARGET_ASSEMBLY="./BepInEx/core/BepInEx.Preloader.dll"
    export LD_LIBRARY_PATH="./doorstop_libs:./linux64"
    export LD_PRELOAD="libdoorstop_x64.so"
fi

# Start server in background and wait
./valheim_server.x86_64 \
    -nographics -batchmode \
    -name "$SERVER_NAME" \
    -port "$SERVER_PORT" \
    -world "$WORLD_NAME" \
    -public "$SERVER_PUBLIC" \
    -savedir "$CONFIG_DIR" \
    ${SERVER_PASS:+-password "$SERVER_PASS"} \
    $([[ "$CROSSPLAY" == "true" ]] && echo "-crossplay") &

SERVER_PID=$!
echo "Server started (PID: $SERVER_PID)"

# Wait for server to exit
wait "$SERVER_PID"
exit $?
