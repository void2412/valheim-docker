#!/bin/bash
# Valheim server updater script
# Stops server if running, updates via steamcmd, then restarts
# Run via: supervisorctl start valheim-updater

set -e
SCRIPT_NAME="updater"
source /opt/valheim/scripts/common.sh

# Stop server if running (via supervisorctl)
stop_server_if_running() {
    # Check if valheim-server is running in supervisord
    local status
    status=$(supervisorctl status valheim-server 2>/dev/null | awk '{print $2}') || true

    if [[ "$status" == "RUNNING" ]]; then
        echo "Server is running, stopping via supervisorctl..."
        supervisorctl stop valheim-server

        # Wait for server process to fully exit
        local timeout=70  # slightly longer than stopwaitsecs
        local elapsed=0
        while is_server_running && [[ $elapsed -lt $timeout ]]; do
            sleep 2
            ((elapsed += 2))
        done

        if is_server_running; then
            echo "Server still running, force killing..."
            pkill -9 -f "valheim_server.x86_64" 2>/dev/null || true
            sleep 2
        fi
        echo "Server stopped"
    else
        echo "Server not running"
    fi
}

# Get current build ID from manifest
get_current_build() {
    local manifest="$VALHEIM_DIR/steamapps/appmanifest_${VALHEIM_APP_ID}.acf"

    if [[ -f "$manifest" ]]; then
        grep -Po '"buildid"\s*"\K[^"]+' "$manifest" 2>/dev/null || echo "0"
    else
        echo "0"
    fi
}

# Run steamcmd update
run_update() {

    local current_build
    current_build=$(get_current_build)

    # Create install directory
    mkdir -p "$VALHEIM_DIR"

    # Run steamcmd with output formatting
    # Use set +e temporarily to capture exit code properly
    # Note: force_install_dir must come before login
    # Retry up to 3 times as steamcmd can fail or timeout
    local exit_code=1
    local attempt=1
    local max_attempts=3
    local timed_out=false
    local output_file="/tmp/steamcmd-output.txt"

    set +e
    while [[ $attempt -le $max_attempts ]]; do
        timed_out=false

        # Capture output to file while also displaying it
        $STEAMCMD \
            +@sSteamCmdForcePlatformType linux \
            +force_install_dir "$VALHEIM_DIR" \
            +login anonymous \
            +app_update $VALHEIM_APP_ID validate \
            +quit 2>&1 | tee "$output_file" | while IFS= read -r line; do
                printf '[valheim-steamcmd] %s\n' "$line"
            done
        exit_code=${PIPESTATUS[0]}

        # Check for timeout pattern in output
        if grep -q "Timed out" "$output_file" 2>/dev/null; then
            timed_out=true
            echo "[valheim-steamcmd] Detected timeout, will retry..."
        fi

        # Success if exit code is 0 AND no timeout detected
        if [[ $exit_code -eq 0 && "$timed_out" == "false" ]]; then
            rm -f "$output_file"
            break
        fi

        # Retry if not last attempt
        if [[ $attempt -lt $max_attempts ]]; then
            echo "[valheim-steamcmd] Attempt $attempt failed, retrying in 5s..."
            sleep 5
        fi
        ((attempt++))
    done
    set -e
    rm -f "$output_file"

    # Fail if exit code non-zero or timed out on last attempt
    if [[ $exit_code -ne 0 || "$timed_out" == "true" ]]; then
        return 1
    fi

    # Ensure executable permissions
    chmod +x "$VALHEIM_DIR/valheim_server.x86_64" 2>/dev/null || true

    return 0
}

# Verify installation
verify_installation() {

    local required_files=(
        "valheim_server.x86_64"
        "valheim_server_Data/Managed/assembly_valheim.dll"
    )

    for file in "${required_files[@]}"; do
        if [[ ! -f "$VALHEIM_DIR/$file" ]]; then
            return 1
        fi
    done

    return 0
}

# Install BepInEx if enabled (steamcmd may have removed it)
install_bepinex() {
    if [[ "$BEPINEX" != "true" ]]; then
        return 0
    fi

    # Check if BepInEx still exists after update
    if [[ -d "$VALHEIM_DIR/BepInEx" && -d "$VALHEIM_DIR/doorstop_libs" ]]; then
        return 0
    fi


    # Fetch BepInExPack_Valheim from Thunderstore
    local api_url="https://thunderstore.io/api/experimental/package/denikson/BepInExPack_Valheim/"


    local pkg_info
    pkg_info=$(curl -fsSL "$api_url" 2>/dev/null) || {
        return 0
    }

    local download_url version
    download_url=$(echo "$pkg_info" | grep -Po '"download_url":\s*"\K[^"]+' | head -1)
    version=$(echo "$pkg_info" | grep -Po '"version_number":\s*"\K[^"]+' | head -1)

    if [[ -z "$download_url" ]]; then
        return 0
    fi


    local tmpfile="/tmp/bepinex.zip"
    if ! curl -fsSL -o "$tmpfile" "$download_url"; then
        return 0
    fi

    # Extract to temp directory
    local extract_dir="/tmp/bepinex_extract"
    rm -rf "$extract_dir"
    mkdir -p "$extract_dir"

    if ! unzip -q -o "$tmpfile" -d "$extract_dir"; then
        rm -f "$tmpfile"
        rm -rf "$extract_dir"
        return 0
    fi
    rm -f "$tmpfile"

    # Install to server directory
    if [[ -d "$extract_dir/BepInExPack_Valheim" ]]; then
        cp -r "$extract_dir/BepInExPack_Valheim/"* "$VALHEIM_DIR/"
    elif [[ -d "$extract_dir/BepInEx" ]]; then
        cp -r "$extract_dir/"* "$VALHEIM_DIR/"
    else
        rm -rf "$extract_dir"
        return 0
    fi
    rm -rf "$extract_dir"

    # Set permissions
    chmod +x "$VALHEIM_DIR/doorstop_libs/"*.so 2>/dev/null || true
}

# Schedule server start after script exits (background job survives script exit)
schedule_server_start() {
    (sleep 2 && supervisorctl start valheim-server) &
    disown
}

# Main
main() {

    # Stop server if running
    stop_server_if_running

    # Run update
    if ! run_update; then
        schedule_server_start
        exit 1
    fi

    # Verify installation
    if ! verify_installation; then
        schedule_server_start
        exit 1
    fi

    # Reinstall BepInEx if needed (steamcmd may have removed it)
    install_bepinex


    # Schedule server start after this script exits
    schedule_server_start
    exit 0
}

main "$@"
