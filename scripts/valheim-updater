#!/bin/bash
# Valheim server updater script
# Stops server if running, updates via steamcmd, then restarts
# Run via: supervisorctl start valheim-updater

set -e
SCRIPT_NAME="updater"
source /opt/valheim/scripts/common.sh

# Stop server if running (via supervisorctl)
stop_server_if_running() {
    # Check if valheim-server is running in supervisord
    local status
    status=$(supervisorctl status valheim-server 2>/dev/null | awk '{print $2}') || true

    if [[ "$status" == "RUNNING" ]]; then
        log "Server is running, stopping for update..."
        supervisorctl stop valheim-server

        # Wait for server process to fully exit
        local timeout=70  # slightly longer than stopwaitsecs
        local elapsed=0
        while is_server_running && [[ $elapsed -lt $timeout ]]; do
            sleep 2
            ((elapsed += 2))
        done

        if is_server_running; then
            log_warn "Server process still running after ${timeout}s, force killing..."
            pkill -9 -f "valheim_server.x86_64" 2>/dev/null || true
            sleep 2
        fi

        log "Server stopped"
    else
        log "Server not running (status: ${status:-unknown})"
    fi
}

# Get current build ID from manifest
get_current_build() {
    local manifest="$VALHEIM_DIR/steamapps/appmanifest_${VALHEIM_APP_ID}.acf"

    if [[ -f "$manifest" ]]; then
        grep -Po '"buildid"\s*"\K[^"]+' "$manifest" 2>/dev/null || echo "0"
    else
        echo "0"
    fi
}

# Run steamcmd update
run_update() {
    log "Running steamcmd update..."
    log "Install directory: $VALHEIM_DIR"

    local current_build
    current_build=$(get_current_build)
    log "Current build ID: $current_build"

    # Create install directory
    mkdir -p "$VALHEIM_DIR"

    # Run steamcmd and pipe output through logger
    # Use set +e temporarily to capture exit code properly
    # Note: force_install_dir must come before login
    # Retry up to 3 times as steamcmd can fail on first attempts
    local exit_code=1
    local attempt=1
    local max_attempts=3

    set +e
    while [[ $attempt -le $max_attempts && $exit_code -ne 0 ]]; do
        log "steamcmd attempt $attempt of $max_attempts..."

        $STEAMCMD \
            +@sSteamCmdForcePlatformType linux \
            +force_install_dir "$VALHEIM_DIR" \
            +login anonymous \
            +app_update $VALHEIM_APP_ID validate \
            +quit 2>&1 | while IFS= read -r line; do
                echo "[$(date '+%Y-%m-%d %H:%M:%S')] [valheim-steamcmd] $line"
                if [[ -S /dev/log ]]; then
                    /usr/local/bin/logger -t "valheim-steamcmd" -p local0.info "$line" 2>/dev/null || true
                fi
            done
        exit_code=${PIPESTATUS[0]}

        if [[ $exit_code -ne 0 && $attempt -lt $max_attempts ]]; then
            log_warn "steamcmd failed with exit code $exit_code, retrying in 5s..."
            sleep 5
        fi
        ((attempt++))
    done
    set -e

    if [[ $exit_code -ne 0 ]]; then
        log_error "steamcmd failed with exit code: $exit_code after $max_attempts attempts"
        return $exit_code
    fi

    local new_build
    new_build=$(get_current_build)
    log "New build ID: $new_build"

    if [[ "$current_build" != "$new_build" ]]; then
        log "Server updated from build $current_build to $new_build"
    else
        log "Server is up to date (build $new_build)"
    fi

    # Ensure executable permissions
    chmod +x "$VALHEIM_DIR/valheim_server.x86_64" 2>/dev/null || true

    return 0
}

# Verify installation
verify_installation() {
    log "Verifying installation..."

    local required_files=(
        "valheim_server.x86_64"
        "valheim_server_Data/Managed/assembly_valheim.dll"
    )

    for file in "${required_files[@]}"; do
        if [[ ! -f "$VALHEIM_DIR/$file" ]]; then
            log_error "Missing required file: $file"
            return 1
        fi
    done

    log "Installation verified successfully"
    return 0
}

# Install BepInEx if enabled (steamcmd may have removed it)
install_bepinex() {
    if [[ "$BEPINEX" != "true" ]]; then
        return 0
    fi

    # Check if BepInEx still exists after update
    if [[ -d "$VALHEIM_DIR/BepInEx" && -d "$VALHEIM_DIR/doorstop_libs" ]]; then
        log "BepInEx still present after update"
        return 0
    fi

    log "BepInEx missing after update, reinstalling..."

    # Fetch BepInExPack_Valheim from Thunderstore
    local api_url="https://thunderstore.io/api/experimental/package/denikson/BepInExPack_Valheim/"

    log "Fetching latest BepInExPack_Valheim from Thunderstore..."

    local pkg_info
    pkg_info=$(curl -fsSL "$api_url" 2>/dev/null) || {
        log_error "Failed to fetch BepInEx package info"
        log_warn "Continuing without BepInEx..."
        return 0
    }

    local download_url version
    download_url=$(echo "$pkg_info" | grep -Po '"download_url":\s*"\K[^"]+' | head -1)
    version=$(echo "$pkg_info" | grep -Po '"version_number":\s*"\K[^"]+' | head -1)

    if [[ -z "$download_url" ]]; then
        log_error "Failed to get BepInEx download URL"
        log_warn "Continuing without BepInEx..."
        return 0
    fi

    log "Downloading BepInExPack_Valheim v${version}..."

    local tmpfile="/tmp/bepinex.zip"
    if ! curl -fsSL -o "$tmpfile" "$download_url"; then
        log_error "Failed to download BepInEx"
        log_warn "Continuing without BepInEx..."
        return 0
    fi

    # Extract to temp directory
    local extract_dir="/tmp/bepinex_extract"
    rm -rf "$extract_dir"
    mkdir -p "$extract_dir"

    if ! unzip -q -o "$tmpfile" -d "$extract_dir"; then
        log_error "Failed to extract BepInEx"
        rm -f "$tmpfile"
        rm -rf "$extract_dir"
        log_warn "Continuing without BepInEx..."
        return 0
    fi
    rm -f "$tmpfile"

    # Install to server directory
    if [[ -d "$extract_dir/BepInExPack_Valheim" ]]; then
        cp -r "$extract_dir/BepInExPack_Valheim/"* "$VALHEIM_DIR/"
    elif [[ -d "$extract_dir/BepInEx" ]]; then
        cp -r "$extract_dir/"* "$VALHEIM_DIR/"
    else
        log_error "Unexpected BepInEx package structure"
        rm -rf "$extract_dir"
        log_warn "Continuing without BepInEx..."
        return 0
    fi
    rm -rf "$extract_dir"

    # Set permissions
    chown -R valheim:valheim "$VALHEIM_DIR"
    chmod +x "$VALHEIM_DIR/doorstop_libs/"*.so 2>/dev/null || true

    if [[ -d "$VALHEIM_DIR/BepInEx" && -d "$VALHEIM_DIR/doorstop_libs" ]]; then
        log "BepInExPack_Valheim v${version} reinstalled successfully"
    else
        log_error "BepInEx installation incomplete"
    fi
}

# Start server after update
start_server_after_update() {
    log "Starting server after update..."
    supervisorctl start valheim-server
    log "Server start command sent"
}

# Main
main() {
    log "=== Valheim Server Updater ==="

    # Stop server if running
    stop_server_if_running

    # Run update
    if ! run_update; then
        log_error "Update failed!"
        log "Attempting to restart server despite update failure..."
        start_server_after_update
        exit 1
    fi

    # Verify installation
    if ! verify_installation; then
        log_error "Installation verification failed!"
        log "Attempting to restart server despite verification failure..."
        start_server_after_update
        exit 1
    fi

    # Reinstall BepInEx if needed (steamcmd may have removed it)
    install_bepinex

    log "Update complete, starting server..."
    start_server_after_update

    log "=== Valheim Server Updater Finished ==="
}

main "$@"
