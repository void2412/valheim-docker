#!/bin/bash
# Valheim initialization script
# Runs once at container startup via supervisord
# Installs server, generates config, sets up cron

set -e
SCRIPT_NAME="init"
source /opt/valheim/scripts/common.sh


# Ensure directories exist with correct permissions
setup_directories() {
    mkdir -p "$CONFIG_DIR/worlds_local" "$BACKUP_DIR" "$VALHEIM_DIR"
}

# Install/update Valheim server on first run
install_server() {
    if [[ -f "$VALHEIM_DIR/valheim_server.x86_64" ]]; then
        return 0
    fi


    /opt/valheim/scripts/valheim-updater

    if [[ ! -f "$VALHEIM_DIR/valheim_server.x86_64" ]]; then
        exit 1
    fi

}

# Install BepInEx if enabled but not found
install_bepinex() {
    if [[ "$BEPINEX" != "true" ]]; then
        return 0
    fi

    # Check if BepInEx already installed (now in server directory)
    if [[ -d "$VALHEIM_DIR/BepInEx" && -d "$VALHEIM_DIR/doorstop_libs" ]]; then
        return 0
    fi


    # Fetch BepInExPack_Valheim from Thunderstore (Valheim-specific pack)
    local package="denikson-BepInExPack_Valheim"
    local api_url="https://thunderstore.io/c/valheim/api/v1/package/"


    # Get package info and extract download URL
    local pkg_info
    pkg_info=$(curl -fsSL "$api_url" 2>/dev/null | grep -o "{[^}]*\"full_name\":\"$package\"[^}]*}" | head -1)

    if [[ -z "$pkg_info" ]]; then
        # Fallback: try direct package endpoint
        pkg_info=$(curl -fsSL "https://thunderstore.io/api/experimental/package/denikson/BepInExPack_Valheim/" 2>/dev/null)
    fi

    local download_url
    local version
    download_url=$(echo "$pkg_info" | grep -Po '"download_url":\s*"\K[^"]+' | head -1)
    version=$(echo "$pkg_info" | grep -Po '"version_number":\s*"\K[^"]+' | head -1)

    if [[ -z "$download_url" ]]; then
        export BEPINEX="false"
        return 0
    fi


    # Download to temp file
    local tmpfile="/tmp/bepinex.zip"
    if ! curl -fsSL -o "$tmpfile" "$download_url"; then
        export BEPINEX="false"
        return 0
    fi

    # Extract to temp directory first (Thunderstore packages have nested structure)
    local extract_dir="/tmp/bepinex_extract"
    rm -rf "$extract_dir"
    mkdir -p "$extract_dir"

    if ! unzip -q -o "$tmpfile" -d "$extract_dir"; then
        rm -f "$tmpfile"
        rm -rf "$extract_dir"
        export BEPINEX="false"
        return 0
    fi
    rm -f "$tmpfile"

    # Thunderstore packages extract to BepInExPack_Valheim/ subdirectory
    # Install directly to server directory
    if [[ -d "$extract_dir/BepInExPack_Valheim" ]]; then
        cp -r "$extract_dir/BepInExPack_Valheim/"* "$VALHEIM_DIR/"
    elif [[ -d "$extract_dir/BepInEx" ]]; then
        # Direct structure (no nested folder)
        cp -r "$extract_dir/"* "$VALHEIM_DIR/"
    else
        rm -rf "$extract_dir"
        export BEPINEX="false"
        return 0
    fi
    rm -rf "$extract_dir"

    # Set permissions
    chmod +x "$VALHEIM_DIR/doorstop_libs/"*.so 2>/dev/null || true

    # Verify installation
    if [[ ! -d "$VALHEIM_DIR/BepInEx" || ! -d "$VALHEIM_DIR/doorstop_libs" ]]; then
        export BEPINEX="false"
    fi
}

# Setup cron jobs
setup_cron() {

    # Use /etc/cron.d/ for Debian cron (requires user field)
    local crontab_file="/etc/cron.d/valheim"

    # Start with empty crontab
    cat > "$crontab_file" << 'CRON_HEADER'
# Valheim Docker cron jobs
SHELL=/bin/bash
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

CRON_HEADER

    # Export env vars for cron jobs
    cat >> "$crontab_file" << EOF
WORLD_NAME=${WORLD_NAME}
CONFIG_DIR=${CONFIG_DIR}
BACKUP_DIR=${BACKUP_DIR}
BACKUPS=${BACKUPS}
BACKUPS_COMPRESS=${BACKUPS_COMPRESS}
BACKUPS_MAX_AGE=${BACKUPS_MAX_AGE}
BACKUPS_MAX_COUNT=${BACKUPS_MAX_COUNT}
BACKUPS_IF_IDLE=${BACKUPS_IF_IDLE}

EOF

    # Backup cron
    if [[ "$BACKUPS" == "true" && -n "$BACKUPS_CRON" ]]; then
        cat >> "$crontab_file" << EOF
# World backup
${BACKUPS_CRON} root /opt/valheim/scripts/log-tag backup /opt/valheim/scripts/valheim-backup > /proc/1/fd/1 2>&1

EOF
    fi

    # Restart cron
    if [[ -n "$RESTART_CRON" ]]; then
        if [[ "$RESTART_IF_IDLE" == "true" ]]; then
            cat >> "$crontab_file" << EOF
# Server restart (idle only)
${RESTART_CRON} root bash -c 'source /opt/valheim/scripts/common.sh && is_server_idle && supervisorctl restart valheim-server' > /proc/1/fd/1 2>&1

EOF
        else
            cat >> "$crontab_file" << EOF
# Server restart
${RESTART_CRON} root supervisorctl restart valheim-server > /proc/1/fd/1 2>&1

EOF
        fi
    fi

    # Cron.d files must end with newline and have proper permissions
    chmod 644 "$crontab_file"
}

# Print configuration summary (no-op, logging removed)
print_config() {
    :
}

schedule_server_start() {
    # Start server, wait for it to be online, then start cron
    # Redirect to /proc/1/fd/1 so output appears in container logs
    (
        source /opt/valheim/scripts/common.sh
        sleep 2
        echo "[valheim-init] Starting server..."
        supervisorctl start valheim-server
        # Wait for server to actually be online before starting cron
        wait_for_server_online 600
        echo "[valheim-init] Starting cron..."
        supervisorctl start cron
    ) > /proc/1/fd/1 2>&1 &
    disown
}

# Start valheim-server via supervisord
start_server() {
    schedule_server_start
}

# Main
main() {
    setup_directories
    install_server
    install_bepinex
    setup_cron
    print_config
    start_server
    exit 0
}

main "$@"
