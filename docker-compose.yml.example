version: "3.8"

services:
  valheim:
    build: .
    image: valheim-server:latest
    container_name: valheim-server
    restart: unless-stopped
    stop_grace_period: 75s
    ports:
      - "2456:2456/udp"
      - "2457:2457/udp"
      - "2457:2457/tcp"
      # Uncomment to expose supervisor web UI
      - "9001:9001/tcp"
    environment:
      # Server settings
      - SERVER_NAME=My Valheim Server
      - SERVER_PORT=2456
      - WORLD_NAME=Dedicated
      - SERVER_PASS=khodam
      - SERVER_PUBLIC=0
      - CROSSPLAY=false

      # Timezone
      - TZ=UTC

      # Restart schedule (cron format, empty to disable)
      - RESTART_CRON=0 5 * * *
      - RESTART_IF_IDLE=true

      # Backup settings
      - BACKUPS=true
      - BACKUPS_CRON=*/10 * * * *
      - BACKUPS_MAX_AGE=3
      - BACKUPS_MAX_COUNT=24
      - BACKUPS_IF_IDLE=true
      - BACKUPS_IDLE_GRACE_PERIOD=3600
      - BACKUPS_COMPRESS=true

      # BepInEx mod support
      - BEPINEX=true

      # Supervisor HTTP (optional)
      - SUPERVISOR_HTTP=true
      - SUPERVISOR_HTTP_PORT=9001
      - SUPERVISOR_HTTP_USER=admin
      - SUPERVISOR_HTTP_PASS=changeme

      # Remote syslog (optional)
      - SYSLOG_REMOTE_HOST=
      - SYSLOG_REMOTE_PORT=514
      - SYSLOG_REMOTE_AND_LOCAL=true

    volumes:
      # Server files + BepInEx (persists across container rebuilds)
      - ./server:/opt/valheim/server
      # World saves
      - ./saves:/saves
      # Backups
      - ./backups:/backups
